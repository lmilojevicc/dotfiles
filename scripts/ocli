#!/usr/bin/env bash

DEFAULT_MODEL="github-copilot/gpt-5-mini"

# Colors
BOLD='\033[1m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
DIM='\033[0;2m'
NC='\033[0m' # No Color

function show_help() {
    echo -e "${BOLD}ocli${NC} - A CLI wrapper for opencode run"
    echo -e ""
    echo -e "${BOLD}USAGE:${NC}"
    echo -e "  ocli [options] [prompt]"
    echo -e ""
    echo -e "${BOLD}OPTIONS:${NC}"
    echo -e "  ${CYAN}-m, --model${NC}    Show a model picker using fzf"
    echo -e "  ${CYAN}-h, --help${NC}     Show this help message"
    echo -e ""
    echo -e "${BOLD}EXAMPLES:${NC}"
    echo -e "  ocli \"how to list files in bash?\""
    echo -e "  ocli -m \"find hidden directories\" (starts interactive model picker with fzf)"
    echo -e "  ocli (starts interactive mode)"
}

function ocli() {
    local model prompt agent show_model_picker=false
    local prompt_args=()

    while [[ $# -gt 0 ]]; do
        case $1 in
        -h | --help)
            show_help
            return 0
            ;;
        -m | --model)
            show_model_picker=true
            shift
            ;;
        *)
            prompt_args+=("$1")
            shift
            ;;
        esac
    done

    prompt="${prompt_args[*]}"
    agent="cli-strict"

    if [[ "$show_model_picker" == true ]]; then
        echo -e "${CYAN}üß† Select model...${NC}"
        model=$(opencode models | fzf \
            --prompt="Model: " \
            --height=50% \
            --border \
            --reverse \
            --header="Press ESC to cancel") || return 1
        echo -e "${GREEN}üß† Using: ${BOLD}$model${NC}"
    else
        model="$DEFAULT_MODEL"
        echo -e "${GREEN}üß† Using default model: ${BOLD}$model${NC}"
        echo -e "${DIM}‚ÑπÔ∏è Use -m to pick your preferred model${NC}\n"
    fi

    if [[ -z "$prompt" ]]; then
        echo -e "${CYAN}üí¨ Enter your prompt:${NC}"
        read prompt
    fi

    echo -e "${YELLOW}‚ö° Running:${NC}"
    echo -e "   ${BOLD}Command:${NC} ${DIM}opencode run --agent $agent --model $model${NC}"
    echo -e "   ${BOLD}Prompt:${NC}  ${DIM}\"$prompt\"${NC}\n"

    opencode run --agent "$agent" --model "$model" "$prompt"
}

ocli "$@"
