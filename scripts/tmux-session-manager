#!/usr/bin/env bash

# --- Configuration & Constants ---
ICON_SESSION=""
ICON_ZOXIDE="󰉖"
ICON_FD="󰥩"

export ICON_SESSION ICON_ZOXIDE ICON_FD

in_tmux() {
  [ -n "$TMUX" ]
}

# --- Generators ---

get_sessions() {
  local icon="$(tput setaf 10)${ICON_SESSION}$(tput sgr0)"
  tmux list-sessions -F '#S' 2>/dev/null | while read -r session; do
    echo "${icon} ${session}"
  done
}

get_zoxide_dirs() {
  local icon="$(tput setaf 4)${ICON_ZOXIDE}$(tput sgr0)"
  zoxide query -l | sed "s|^$HOME|~|; s|^|${icon} |"
}

get_fd_dirs() {
  local icon="$(tput setaf 6)${ICON_FD}$(tput sgr0)"
  fd -H -a -d 2 -t d -E .Trash . ~ 2>/dev/null | sed "s|^$HOME|~|; s|^|${icon} |"
}

get_all() {
  get_sessions
  get_zoxide_dirs
  get_fd_dirs
}

# --- Helpers ---

strip_icon() {
  local clean_line
  clean_line=$(echo "$1" | sed "s/$(printf '\033')\[[0-9;]*m//g")
  echo "${clean_line#* }"
}

strip_colors() {
  echo "$1" | sed "s/$(printf '\033')\[[0-9;]*m//g"
}

switch_to_session() {
  local session="$1"
  if in_tmux; then
    tmux switch-client -t "$session"
  else
    tmux attach-session -t "$session"
  fi
}

create_session_from_dir() {
  local dir="$1"
  local session_name

  if [ ! -d "$dir" ]; then
    if in_tmux; then
      tmux display-message -d 2000 "❌ Error: Directory '$dir' does not exist."
    fi
    return 1
  fi

  session_name=$(basename "$dir")

  if [ "$session_name" = "." ]; then
    session_name=$(basename "$(pwd)")
  fi

  if [[ "$session_name" == .* ]]; then
    session_name="dot_${session_name#.}"
  fi

  session_name=$(echo "$session_name" | tr . _ | tr : _)

  if ! tmux has-session -t "$session_name" 2>/dev/null; then
    tmux new-session -d -s "$session_name" -c "$dir"
  fi

  if tmux has-session -t "$session_name" 2>/dev/null; then
    switch_to_session "$session_name"
  else
    # Fallback debug message if creation completely failed
    if in_tmux; then
      tmux display-message -d 2000 "❌ Failed to create session '$session_name'"
    fi
  fi
}

run_yazi_and_create_session() {
  local tmp_file
  tmp_file=$(mktemp)
  yazi --cwd-file="$tmp_file"
  if [ -s "$tmp_file" ]; then
    local exit_dir
    exit_dir=$(cat "$tmp_file")
    if [ -d "$exit_dir" ]; then
      create_session_from_dir "$exit_dir"
    fi
  fi
  rm -f "$tmp_file"
}

# --- Action Handlers ---

delete_item() {
  local raw_line="$1"
  local clean_line
  clean_line=$(strip_colors "$raw_line")

  if [[ "$clean_line" == "$ICON_SESSION"* ]]; then
    local session_name
    session_name=$(strip_icon "$raw_line")
    tmux kill-session -t "$session_name" 2>/dev/null
  fi
}

# --- FZF Logic ---

fzf_with_style() {
  local fzf_opts=(
    --ansi
    --color=spinner:#F5E0DC,hl:#F38BA8
    --color=fg:#CDD6F4,header:#94E2D5,info:#CBA6F7,pointer:#F38BA8
    --color=marker:#B4BEFE,fg+:#CDD6F4,prompt:#CBA6F7,hl+:#F38BA8
    --color=selected-bg:#1e1e2e,current-bg:#1e1e2e
    --color=border:#313244,label:#CDD6F4 
    --style full
    --preview-window 'right:55%'
    --bind 'alt-p:toggle-preview'
  )

  if [ -n "$TMUX" ]; then
    fzf "${fzf_opts[@]}" "$@" --tmux 90%,80% --border=none --layout=default
  else
    fzf "${fzf_opts[@]}" "$@" --height 90% --layout=reverse
  fi
}

fzf_unified_manager() {
  local mode=""
  local rename_target=""

  local mode_file=$(mktemp)
  echo "--get-all" >"$mode_file"
  trap "rm -f '$mode_file'" EXIT

  while :; do
    if [[ "$mode" == "rename" ]]; then
      new_name=$(
        printf "" | fzf_with_style \
          --print-query \
          --prompt="Rename session '$rename_target' to: " \
          --header="Type new session name and hit Enter, or Esc to cancel" \
          --border-label " Rename Session "
      )
      new_name=$(head -1 <<<"$new_name")
      if [[ -n "$new_name" && "$new_name" != "$rename_target" ]]; then
        tmux rename-session -t "$rename_target" "$new_name"
      fi
      mode=""
      rename_target=""
      continue
    fi

    unified_list=$(
      get_all |
        fzf_with_style \
          --header=$'Enter: Switch/Create | Esc: Quit | ^R: Rename | ^X: Delete \n^A: All | ^T: Sessions | ^Z: Zoxide | ^F: fd | ^Y: Yazi | Alt-p: Toggle Preview' \
          --border-label ' Session Manager ' \
          --prompt='> ' \
          --bind "ctrl-t:execute-silent(echo '--get-sessions' > '$mode_file')+reload('${BASH_SOURCE[0]}' --get-sessions)" \
          --bind "ctrl-z:execute-silent(echo '--get-zoxide' > '$mode_file')+reload('${BASH_SOURCE[0]}' --get-zoxide)" \
          --bind "ctrl-f:execute-silent(echo '--get-fd' > '$mode_file')+reload('${BASH_SOURCE[0]}' --get-fd)" \
          --bind "ctrl-a:execute-silent(echo '--get-all' > '$mode_file')+reload('${BASH_SOURCE[0]}' --get-all)" \
          --bind "ctrl-x:transform:[[ \"{}\" == *\"$ICON_SESSION\"* ]] && echo \"execute-silent('${BASH_SOURCE[0]}' --delete-item {})+reload('${BASH_SOURCE[0]}' \$(cat '$mode_file'))\" || echo \"\"" \
          --bind "ctrl-r:transform:[[ \"{}\" == *\"$ICON_SESSION\"* ]] && echo \"accept\" || echo \"\"" \
          --preview '
            line=$(echo {} | sed "s/$(printf "\033")\[[0-9;]*m//g")
            if [[ "$line" == "$ICON_SESSION"* ]]; then
              target=$(echo "$line" | cut -d" " -f2-)
              tmux capture-pane -ep -t "$target" 2>/dev/null
            elif [[ "$line" == "$ICON_ZOXIDE"* ]] || [[ "$line" == "$ICON_FD"* ]]; then
              target="$(echo "$line" | cut -d" " -f2-)"
              target="${target/#\~/$HOME}"
              eza -lah --icons=always --sort=name --group-directories-first --color=always "$target" | head -200
            fi
          ' \
          --expect enter,ctrl-n,ctrl-y
    )

    if [ -z "$unified_list" ]; then break; fi

    key=$(head -1 <<<"$unified_list")
    selected=$(tail -n +2 <<<"$unified_list" | head -1)

    if [ -z "$key" ] && [ -n "$selected" ]; then
      key="ctrl-r"
    fi

    clean_selected=$(strip_colors "$selected")

    if [[ "$clean_selected" == "$ICON_SESSION"* ]]; then
      session_name=$(strip_icon "$selected")
      case "$key" in
      enter)
        switch_to_session "$session_name"
        break
        ;;
      ctrl-r)
        mode="rename"
        rename_target="$session_name"
        ;;
      ctrl-y)
        run_yazi_and_create_session
        break
        ;;
      esac
    elif [[ "$clean_selected" == "$ICON_ZOXIDE"* ]] || [[ "$clean_selected" == "$ICON_FD"* ]]; then
      dir_path=$(strip_icon "$selected")
      dir_path="${dir_path# }"
      dir_path="${dir_path/#\~/$HOME}"

      case "$key" in
      enter)
        create_session_from_dir "$dir_path"
        break
        ;;
      ctrl-y)
        run_yazi_and_create_session
        break
        ;;
      esac
    fi
  done
}

case "$1" in
--get-sessions)
  get_sessions
  exit 0
  ;;
--get-zoxide)
  get_zoxide_dirs
  exit 0
  ;;
--get-fd)
  get_fd_dirs
  exit 0
  ;;
--get-all)
  get_all
  exit 0
  ;;
--delete-item)
  delete_item "$2"
  exit 0
  ;;
esac

fzf_unified_manager
